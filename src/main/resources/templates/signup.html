<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sign-Up page WonderBoot</title>
    <link rel="stylesheet" th:href="@{/css/login_signup_styles.css}">
    <!-- Incluir el CSS de Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Incluir jQuery (Select2 depende de jQuery) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Incluir el JS de Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
</head>
<body>
<div class="login-container">
    <!-- Display error message if credentials are incorrect -->
    <div th:if="${param.error}" class="error-message">The Username or Password are incorrect</div>
    <!-- Login form -->
    <h2>REGISTRATION</h2>
    <form th:action="@{/signup}" th:object="${registrationUser}" method="post">
        <input id="username" type="text" th:field="*{username}" placeholder="Username" required />
        <input id="name" type="text" th:field="*{name}" placeholder="Name" required />
        <input id="surname" type="text" th:field="*{surname}" placeholder="Surname" required />

        <div th:classappend="${#fields.hasErrors('country')} ? 'is-invalid'">
            <!--
            Made with a placeholder
            <label th:for="${#ids.next('country.code')}">Country</label>
            -->
            <div>
                <select class="country-dropdown" th:field="*{country.code}" th:classappend="${#fields.hasErrors('country')} ? 'is-invalid'">
                    <option value="Country"></option>
                    <option

                            th:if="*{country.code}"
                            th:value="*{country.code}"
                            th:text="*{country.name}"
                    ></option>
                </select>
                <span th:if="${#fields.hasErrors('country')}" th:errors="*{country}" class="invalid-feedback"></span>
            </div>
        </div>

        <input type="email" th:field="*{email}" id="email" placeholder="Email" required />
        <input id="password" type="password" th:field="*{password}" placeholder="Password" required />
        <input id="repeatPassword" type="password" th:field="*{repeatPassword}" placeholder="Repeat Password" required />
        <input type="date" th:field="*{dateOfBirth}" id="date">
        <input type="submit" value="Register">
        <a th:href="@{/login}">Cancel</a>
    </form>
</div>
<!-- Footer incluido -->
<div th:insert="fragments/footer :: footer"></div>
</body>
<script>
    // Escribimos la cadena vacía para que el IDE no lo detecte como un error de sintaxis, aunque cualquier valor posterior a la expresión será sobrescrito
    const flagsBaseUrl = "[[@{/img/flags}]]" ;

    $(document).ready(function() {
        $('.country-dropdown').select2({
            placeholder: 'Country', // Texto que aparece por defecto
            allowClear: true, // Habilita el botón de borrar (X)
            theme: 'bootstrap-5', // Tema Bootstrap
            width: '100%', // Asegura que ocupa todo el ancho
            minimumInputLength: 1, // Requiere al menos 1 caracter
            ajax: {
                url: "http://localhost:8080/api/countries",
                dataType: 'json',
                delay: 250,
                processResults(data) {
                    return {
                        results: data.map(country => ({
                            id: country.code,
                            text: country.name
                        }))
                    };
                }
            },
            templateResult: formatDropdownItem,
            templateSelection: formatDropdownItem
        });
        // Forzar que Select2 muestre el placeholder al cargar la página
        $('#countrySelect').val(null).trigger('change');

        function formatDropdownItem(data) {
            if (!data.id) {
                return data.text; // Si no hay ID, muestra solo el texto
            }

            // Renderiza bandera + nombre
            const $flag = $('<img class="country-flag">').attr({
                src: `${flagsBaseUrl}/${data.id.toLowerCase()}.svg`,
                alt: data.text,
                title: data.text
            });

            return $('<span></span>').append($flag, ` ${data.text}`);
        }
    });
</script>
</html>